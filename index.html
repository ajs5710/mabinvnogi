
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Color Wheel with Accordion Markers</title>
  <style>
    body {
      margin: 0;
      background: #222;
      color: #fff;
      font-family: sans-serif;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: row;
      align-items: stretch;
    }
    #left {
      width: 50vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #right {
      width: 50vw;
      padding: 40px 0 40px 0;
      box-sizing: border-box;
      background: #181818;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    canvas {
      background: #111;
      border-radius: 50%;
      box-shadow: 0 0 12px #0008;
      display: block;
    }
    h1 {
      margin: 0 0 20px 40px;
    }
    #error {
      color: #ff7070;
      margin: 20px 40px 0 40px;
    }
    .accordion {
      width: 100%;
    }
    .accordion-item {
      background: #232323;
      border-bottom: 1px solid #333;
    }
    .accordion-header {
      cursor: pointer;
      padding: 18px 40px;
      font-size: 1.08rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      outline: none;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      color: #fff;
      transition: background 0.2s;
      position: relative;
    }
    .accordion-header.active,
    .accordion-header:hover {
      background: #303036;
    }
    .swatch {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid #fff;
      margin-right: 16px;
      box-shadow: 0 0 3px #000a;
      flex-shrink: 0;
    }
    .accordion-panel {
      max-height: 0;
      overflow: hidden;
      background: #27272c;
      transition: max-height 0.25s cubic-bezier(0.4, 0.0, 0.2, 1);
      padding: 0 40px;
    }
    .accordion-panel-content {
      padding: 18px 0;
      color: #e0e0e0;
      font-size: 0.98rem;
    }
    .accordion-header .arrow {
      margin-left: auto;
      transition: transform 0.25s;
      font-size: 1.2em;
      color: #aaa;
    }
    .accordion-header.active .arrow {
      transform: rotate(90deg);
      color: #fff;
    }
    @media (max-width: 900px) {
      #left, #right {
        width: 100vw;
        height: auto;
        padding: 0;
      }
      body {
        flex-direction: column;
      }
      #right {
        padding: 0 0 40px 0;
      }
      h1 {
        margin: 0 0 20px 0;
        text-align: center;
      }
      .accordion-header, .accordion-panel {
        padding-left: 16px;
        padding-right: 16px;
      }
    }
  </style>
</head>
<body>
  <div id="left">
    <canvas id="colorWheel" width="400" height="400"></canvas>
  </div>
  <div id="right">
    <h1>Dyes</h1>
    <div class="accordion" id="markerAccordion"></div>
    <div id="error"></div>
  </div>
  <script>

    // --- Drawing the color wheel (static part) ---
    const canvas = document.getElementById('colorWheel');
    const ctx = canvas.getContext('2d');
    const radius = canvas.width / 2;
    const centerX = radius;
    const centerY = radius;

    function drawColorWheel() {
      for (let angle = 0; angle < 360; angle += 1) {
        const startAngle = (angle - 1) * Math.PI / 180;
        const endAngle = angle * Math.PI / 180;
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, startAngle, endAngle, false);
        ctx.closePath();
        ctx.fillStyle = `hsl(${angle}, 100%, 50%)`;
        ctx.fill();
      }
      // Optional: Draw a white circle in the center for aesthetics
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius * 0.5, 0, 2 * Math.PI);
      ctx.closePath();
      ctx.fillStyle = "#fff";
      ctx.globalAlpha = 0.1;
      ctx.fill();
      ctx.globalAlpha = 1.0;
    }

    drawColorWheel();

    // --- HSL conversion utility ---
    function colorToHSL(color) {
      // Draw color to a 1x1 canvas to extract its RGB value
      const temp = document.createElement('canvas');
      temp.width = temp.height = 1;
      const tctx = temp.getContext('2d');
      tctx.clearRect(0, 0, 1, 1);
      tctx.fillStyle = color;
      tctx.fillRect(0, 0, 1, 1);
      const d = tctx.getImageData(0, 0, 1, 1).data;
      const r = d[0]/255, g = d[1]/255, b = d[2]/255;
      const max = Math.max(r,g,b), min = Math.min(r,g,b);
      let h, s, l = (max+min)/2;
      if(max === min){
        h = s = 0; // achromatic
      }else{
        const diff = max-min;
        s = l > 0.5 ? diff/(2-max-min) : diff/(max+min);
        switch(max){
          case r: h = (g-b)/diff + (g < b ? 6 : 0); break;
          case g: h = (b-r)/diff + 2; break;
          case b: h = (r-g)/diff + 4; break;
        }
        h = h*60;
      }
      return { h: h||0, s: s||0, l: l||0 };
    }

    // --- Draw marker ---
    let markerPositions = [];
    function drawMarker(h, s, color) {
      // h: [0,360], s: [0,1]
      // Place marker at correct angle and distance from center (saturation)
      const angleRad = (h) * Math.PI / 180; // -90 to start at top
      const r = s * radius * 0.98; // 0.98 so markers don't go outside edge
      const x = centerX + r * Math.cos(angleRad);
      const y = centerY + r * Math.sin(angleRad);

      markerPositions.push({
        x, y, 
        radius: 6,
        id: color
      })

      // // Outer white halo for visibility
      // ctx.beginPath();
      // ctx.arc(x, y, 11, 0, 2 * Math.PI);
      // ctx.fillStyle = "#fff";
      // ctx.globalAlpha = 0.9;
      // ctx.fill();
      // ctx.globalAlpha = 1.0;
      // Marker circle
      ctx.beginPath();
      ctx.arc(x, y, 6, 0, 2 * Math.PI);
      ctx.fillStyle = color;
      ctx.strokeStyle = "#111";
      // ctx.lineWidth = 2;
      ctx.fill();
      ctx.stroke();
    }
    canvas.addEventListener('click', (e) => {
      // Get mouse position relative to canvas
      const rect = canvas.getBoundingClientRect();
      const mx = e.clientX - rect.left;
      const my = e.clientY - rect.top;

      // 3. Check if click is inside any marker
      for (let i = 0; i < markerPositions.length; i++) {
        const m = markerPositions[i];
        const dx = mx - m.x;
        const dy = my - m.y;
        if (dx*dx + dy*dy <= m.radius*m.radius) {
          // 4. Respond! For example, alert or call a function
          // alert('Clicked marker: ' + m.id);
          const clicked = document.getElementById(m.id);
          clicked.click();

          break;
        }
      }
    });


    // convert hex code to rgb values
    function hexToRgb(hex) {
      // Remove the '#' if it exists
      hex = hex.replace("#", "");

      // Handle shorthand hex codes (e.g., #abc)
      if (hex.length === 3) {
        hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
      }

      // Parse hex values to integers
      const r = parseInt(hex.substring(0, 2), 16);
      const g = parseInt(hex.substring(2, 4), 16);
      const b = parseInt(hex.substring(4, 6), 16);

      // Return RGB string
      return [r,g,b];
    }

    // --- On page load, fetch the markers file ---
    window.addEventListener('DOMContentLoaded', () => {
      fetch('pets/data.json')
        .then(resp => {
          if (!resp.ok) throw new Error("Failed to load data.json");
          return resp.json();
        })
        .then(data => {
          // // data is of format
          // data is in format of {
          //   "dyes_by_color": {
          //     "#RRGGBB": [{
          //       "pet": path to the pet profile pic,
          //       "item": path to the item pic,
          //       "item_type": folder of item (what image matching thought it was),
          //       "item_name": name of item according to OCR,
          //       "item_description": full text of item according to OCR
          //     }]
          //   },
          //   "unknown_items_by_name": {
          //     "ItemName": [{
          //       "pet": path to the pet profile pic,
          //       "item": path to the item pic,
          //       "item_type": folder of item (what image matching thought it was),
          //       "item_name": name of item according to OCR,
          //       "item_description": full text of item according to OCR
          //     }]
          //   }
          // }
          const accordion = document.getElementById('markerAccordion');

          const sortedColors = Object.keys(data["dyes_by_color"]).sort();
          sortedColors.forEach(color => {
            const dyes = data["dyes_by_color"][color];
            const hsl = colorToHSL(color);
            drawMarker(hsl.h, hsl.s, color)

            const item = document.createElement("div");
            item.className = 'accordion-item'

            const header = document.createElement('button');
            header.className = 'accordion-header';
            header.type = 'button';
            header.setAttribute('id', color);
            header.setAttribute('aria-expanded', 'false');

            const swatch = document.createElement('span');
            swatch.className = 'swatch';
            swatch.style.background = color;
            header.appendChild(swatch);

            const title = document.createElement('span');
            title.textContent = (color) + " ";
            header.appendChild(title);

            const arrow = document.createElement('span');
            arrow.className = 'arrow';
            arrow.innerHTML = '&#9654;'; // right-pointing triangle
            header.appendChild(arrow);

            const panel = document.createElement('div');
            panel.className = 'accordion-panel';

            // Panel content
            const content = document.createElement('div');
            content.className = 'accordion-panel-content';


            //       "pet": path to the pet profile pic,
            //       "item": path to the item pic,
            //       "item_type": folder of item (what image matching thought it was),
            //       "item_name": name of item according to OCR,
            //       "item_description": full text of item according to OCR
            dyes.forEach(function(dye){
              const dyeImg = document.createElement('img');
              dyeImg.src = dye["item"];
              dyeImg.setAttribute("loading", "lazy");
              dyeImg.setAttribute("width", "600");
              dyeImg.setAttribute("height", "490");
              dyeImg.setAttribute("data-raw", dye["item_type"]);
              dyeImg.setAttribute("data-name", dye["item_name"]);
              dyeImg.setAttribute("data-desc", dye["item_description"]);
              
              const petLink = document.createElement('a');
              petLink.href = dye["pet"];
              petLink.appendChild(dyeImg);
              
              content.appendChild(petLink)
            })

            panel.appendChild(content);

            // Accordion open/close logic
            header.addEventListener('click', function() {
              const isActive = header.classList.contains('active');
              // Close all
              accordion.querySelectorAll('.accordion-header').forEach(h => {
                h.classList.remove('active');
                h.setAttribute('aria-expanded', 'false');
              });
              accordion.querySelectorAll('.accordion-panel').forEach(p => {
                p.style.maxHeight = null;
              });
              // Open this one if was not active
              if (!isActive) {
                header.classList.add('active');
                header.setAttribute('aria-expanded', 'true');
                panel.style.maxHeight = panel.scrollHeight + "px";
                panel.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }
            });

            item.appendChild(header);
            item.appendChild(panel);
            accordion.appendChild(item);
          })

          const sortedUnknowns = Object.keys(data["unknown_items_by_name"]).sort();
          sortedUnknowns.forEach(item_name => {
            const items = data["unknown_items_by_name"][item_name];

            const item = document.createElement("div");
            item.className = 'accordion-item'

            const header = document.createElement('button');
            header.className = 'accordion-header';
            header.type = 'button';
            header.setAttribute('id', item_name);
            header.setAttribute('aria-expanded', 'false');

            // const swatch = document.createElement('span');
            // swatch.className = 'swatch';
            // swatch.style.background = color;
            // header.appendChild(swatch);

            const title = document.createElement('span');
            title.textContent = item_name;
            header.appendChild(title);

            const arrow = document.createElement('span');
            arrow.className = 'arrow';
            arrow.innerHTML = '&#9654;'; // right-pointing triangle
            header.appendChild(arrow);

            const panel = document.createElement('div');
            panel.className = 'accordion-panel';
            // if (i === 0) {
            //   header.classList.add('active');
            //   panel.style.maxHeight = "200px";
            // }

            // Panel content
            const content = document.createElement('div');
            content.className = 'accordion-panel-content';


            //       "pet": path to the pet profile pic,
            //       "item": path to the item pic,
            //       "item_type": folder of item (what image matching thought it was),
            //       "item_name": name of item according to OCR,
            //       "item_description": full text of item according to OCR
            items.forEach(function(i){
              const itemImg = document.createElement('img');
              itemImg.src = i["item"]
              itemImg.setAttribute("loading", "lazy");
              itemImg.setAttribute("width", "600");
              itemImg.setAttribute("height", "490");
              itemImg.setAttribute("data-raw", i["item_type"]);
              itemImg.setAttribute("data-name", i["item_name"]);
              itemImg.setAttribute("data-desc", i["item_description"]);
              
              
              const petLink = document.createElement('a');
              petLink.href = i["pet"];
              petLink.appendChild(itemImg);
              
              content.appendChild(petLink)
            })

            panel.appendChild(content);

            // Accordion open/close logic
            header.addEventListener('click', function() {
              const isActive = header.classList.contains('active');
              // Close all
              accordion.querySelectorAll('.accordion-header').forEach(h => {
                h.classList.remove('active');
                h.setAttribute('aria-expanded', 'false');
              });
              accordion.querySelectorAll('.accordion-panel').forEach(p => {
                p.style.maxHeight = null;
              });
              // Open this one if was not active
              if (!isActive) {
                header.classList.add('active');
                header.setAttribute('aria-expanded', 'true');
                panel.style.maxHeight = panel.scrollHeight + "px";
                panel.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }
            });

            item.appendChild(header);
            item.appendChild(panel);
            accordion.appendChild(item);
          })
          
        })
        .catch(err => {
          document.getElementById('error').textContent = err.message;
        });
    });
  </script>
</body>
</html>
